---
import BaseLayout from "@layouts/BaseLayout.astro";
import ModelViewer from "@components/ModelViewer.astro";
import {
  getProjectBySlug,
  getMediaUrl,
  getMediaUrlsFromGallery,
} from "@lib/content";

const { slug } = Astro.params;
if (!slug) return new Response("Not found", { status: 404 });

const project = await getProjectBySlug(slug);
if (!project) return new Response("Not found", { status: 404 });

const title = project.name ?? `Preview: ${project.slug}`;
const description = project.description?.trim() ?? "";

const glbUrl = getMediaUrl(project.model);
const imageUrls = getMediaUrlsFromGallery(project.images);
const coverImage = imageUrls[0] ?? "";

const WHATSAPP_BASE = "https://wa.me/524771737105";
function buildWhatsAppLink(intent: "approve" | "changes" | "info") {
  const subject = project.name ?? slug;
  const messages = {
    approve: `Hola, revisé la propuesta "${subject}" y me gustaría avanzar con la aprobación. ¿Me comparten siguientes pasos?`,
    changes: `Hola, revisé la propuesta "${subject}" y me gustaría solicitar algunos ajustes. ¿Podemos revisarlos?`,
    info: `Hola, revisé la propuesta "${subject}" y tengo algunas dudas. ¿Me pueden ayudar?`,
  } as const;

  return `${WHATSAPP_BASE}?text=${encodeURIComponent(
    `${messages[intent]}\n\nReferencia: ${slug}`,
  )}`;
}

const summaryText =
  description ||
  "Revisa esta propuesta, valida detalles y confirma por WhatsApp si avanzamos o si necesitas ajustes.";

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, s-maxage=120, stale-while-revalidate=300",
);
---

<BaseLayout
  title={`${title} | Propuesta LuminArte`}
  description={summaryText}
  ogImage={coverImage}
  noindex
  headerCompact
  mainClass="px-4 pb-6"
>
  <section class="mx-auto w-full max-w-6xl">
    <div class="rounded-3xl border border-white/[0.12] bg-white/[0.06] p-4 shadow-[0_20px_60px_rgba(0,0,0,0.2)] backdrop-blur-md md:p-6">
      <div class="flex flex-col gap-2 border-b border-white/10 pb-4 md:pb-5">
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-white/70">
          Propuesta LuminArte
        </p>
        <h1 class="text-2xl font-bold leading-tight md:text-4xl">{title}</h1>
        <p class="max-w-3xl text-sm leading-6 text-white/80 md:text-base">
          {summaryText}
        </p>
      </div>

      <div class="mt-5 grid gap-5 lg:grid-cols-[minmax(0,1.45fr)_minmax(280px,0.75fr)]">
        <div class="rounded-2xl border border-white/10 bg-black/20 p-3">
          {
            glbUrl ? (
              <ModelViewer
                url={glbUrl}
                name={title}
                isInteractive={true}
                height="min(62vh, 560px)"
              />
            ) : (
              <div class="flex min-h-[320px] flex-col items-center justify-center rounded-xl border border-dashed border-white/20 bg-white/[0.03] px-5 text-center">
                <p class="text-lg font-semibold">Modelo 3D no disponible por ahora</p>
                <p class="mt-2 max-w-sm text-sm text-white/75">
                  Esta propuesta aún no incluye el archivo 3D. Escríbenos por WhatsApp y
                  te compartimos una actualización o alternativas visuales.
                </p>
                <a
                  href={buildWhatsAppLink("info")}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn-press btn-secondary mt-5 text-sm"
                >
                  Solicitar actualización
                </a>
              </div>
            )
          }
        </div>

        <aside class="flex flex-col gap-4 rounded-2xl border border-white/10 bg-black/15 p-4">
          <div class="rounded-xl border border-white/10 bg-white/[0.045] p-4">
            <p class="text-xs font-semibold uppercase tracking-[0.16em] text-white/70">
              Cómo revisar esta propuesta
            </p>
            <ul class="mt-3 space-y-2 text-sm leading-6 text-white/85">
              <li>Revisa el modelo 3D y las imágenes.</li>
              <li>Valida si la propuesta cumple lo que necesitas.</li>
              <li>Escríbenos por WhatsApp para aprobar o pedir cambios.</li>
            </ul>
          </div>

          <div class="rounded-xl border border-white/10 bg-gradient-to-b from-white/[0.07] to-white/[0.03] p-4">
            <p class="text-xs font-semibold uppercase tracking-[0.16em] text-white/70">
              Siguiente paso
            </p>
            <p class="mt-2 text-sm leading-6 text-white/85">
              Elige una opción y te respondemos para continuar.
            </p>
            <div class="mt-4 grid gap-2">
              <a
                href={buildWhatsAppLink("changes")}
                target="_blank"
                rel="noopener noreferrer"
                class="btn-press btn-secondary text-sm"
              >
                Solicitar ajustes
              </a>
              <a
                href={buildWhatsAppLink("approve")}
                target="_blank"
                rel="noopener noreferrer"
                class="btn-press btn-primary text-sm"
              >
                Aprobar por WhatsApp
              </a>
            </div>
          </div>

          <div class="rounded-xl border border-white/10 bg-white/[0.035] p-4 text-sm text-white/75">
            <p class="font-semibold text-white">Acompañamiento</p>
            <p class="mt-1 leading-6">
              Si algo no coincide con tu idea, te ayudamos a ajustarlo.
            </p>
          </div>
        </aside>
      </div>

      {
        description && (
          <section class="mt-6 rounded-2xl border border-white/10 bg-white/[0.04] p-4 md:p-5">
            <h2 class="text-lg font-semibold md:text-xl">Detalles de la propuesta</h2>
            <p class="mt-3 whitespace-pre-line text-sm leading-7 text-white/85 md:text-base">
              {description}
            </p>
          </section>
        )
      }

      {
        imageUrls.length > 0 && (
          <section class="mt-6" data-gallery-root>
            <div class="flex items-center justify-between gap-3">
              <h2 class="text-lg font-semibold md:text-xl">Apoyos visuales</h2>
              <span class="text-xs text-white/60">
                {imageUrls.length} {imageUrls.length === 1 ? "imagen" : "imágenes"}
              </span>
            </div>

            <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {imageUrls.map((u: string, index: number) => (
                <button
                  type="button"
                  data-gallery-open
                  data-gallery-index={index}
                  data-gallery-src={u}
                  data-gallery-alt={`Referencia visual ${index + 1} de ${title}`}
                  class="group block overflow-hidden rounded-2xl border border-white/10 bg-black/20 text-left cursor-pointer"
                  aria-label={`Abrir imagen ${index + 1} en pantalla completa`}
                >
                  <div class="relative aspect-[16/10] overflow-hidden">
                    <img
                      src={u}
                      alt={`Referencia visual ${index + 1} de ${title}`}
                      loading="lazy"
                      decoding="async"
                      class="h-full w-full object-cover transition duration-300 group-hover:scale-[1.03]"
                    />
                    <span class="absolute bottom-2 left-2 rounded-lg bg-black/55 px-2 py-1 text-xs font-medium text-white">
                      Ampliar
                    </span>
                  </div>
                </button>
              ))}
            </div>

          </section>
        )
      }

      <section class="mt-6 rounded-2xl border border-white/10 bg-gradient-to-r from-white/[0.07] to-white/[0.02] p-4 md:flex md:items-center md:justify-between md:gap-5">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.16em] text-white/70">
            Cierre de revisión
          </p>
          <h2 class="mt-1 text-lg font-semibold md:text-xl">
            Dinos si avanzamos o si quieres cambios
          </h2>
          <p class="mt-1 text-sm leading-6 text-white/75">
            Te respondemos por WhatsApp con los siguientes pasos.
          </p>
        </div>
        <div class="mt-4 grid gap-2 md:mt-0 md:min-w-[18rem]">
          <a
            href={buildWhatsAppLink("changes")}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-press btn-secondary text-sm"
          >
            Quiero solicitar cambios
          </a>
          <a
            href={buildWhatsAppLink("approve")}
            target="_blank"
            rel="noopener noreferrer"
            class="btn-press btn-primary text-sm"
          >
            Confirmar propuesta
          </a>
        </div>
      </section>
    </div>
  </section>

  {
    imageUrls.length > 0 && (
      <div
        class="fixed inset-0 z-[120] hidden bg-white/[0.03] backdrop-blur-lg"
        data-gallery-modal
        aria-hidden="true"
      >
        <div class="absolute inset-0" data-gallery-close></div>

        <div class="relative z-10 flex h-full w-full flex-col">
          <div class="flex items-center justify-between gap-3 px-4 py-4 md:px-6">
            <p class="rounded-full border border-white/15 bg-black/30 px-3 py-1 text-sm text-white/85" data-gallery-counter>
            </p>
            <button
              type="button"
              class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-[#ED3337] text-3xl leading-none text-white shadow-lg hover:brightness-110"
              data-gallery-close
              aria-label="Cerrar galería"
              title="Cerrar"
            >
              ×
            </button>
          </div>

          <div class="relative flex min-h-0 flex-1 items-center justify-center px-3 pb-4 md:px-6 md:pb-6">
            <button
              type="button"
              class="absolute left-3 top-1/2 z-20 hidden h-14 w-14 -translate-y-1/2 items-center justify-center rounded-2xl bg-black/35 text-4xl leading-none text-white shadow-lg backdrop-blur-sm hover:bg-black/45 md:left-6 md:h-16 md:w-16 md:text-5xl"
              data-gallery-prev
              aria-label="Imagen anterior"
            >
              <span class="-mt-1 block">‹</span>
            </button>

            <div class="flex h-full w-full items-center justify-center rounded-2xl bg-black/15 p-2 md:p-3">
              <img
                src=""
                alt=""
                class="max-h-full max-w-full rounded-xl object-contain"
                data-gallery-image
              />
            </div>

            <button
              type="button"
              class="absolute right-3 top-1/2 z-20 hidden h-14 w-14 -translate-y-1/2 items-center justify-center rounded-2xl bg-black/35 text-4xl leading-none text-white shadow-lg backdrop-blur-sm hover:bg-black/45 md:right-6 md:h-16 md:w-16 md:text-5xl"
              data-gallery-next
              aria-label="Siguiente imagen"
            >
              <span class="-mt-1 block">›</span>
            </button>
          </div>
        </div>
      </div>
    )
  }
</BaseLayout>

{
  imageUrls.length > 0 && (
    <script is:inline>
      (() => {
        const root = document.querySelector("[data-gallery-root]");
        if (!root) return;

        const modal = document.querySelector("[data-gallery-modal]");
        const image = modal?.querySelector("[data-gallery-image]");
        const counter = modal?.querySelector("[data-gallery-counter]");
        const openButtons = Array.from(root.querySelectorAll("[data-gallery-open]"));
        const closeButtons = Array.from(document.querySelectorAll("[data-gallery-close]"));
        const prevBtn = modal?.querySelector("[data-gallery-prev]");
        const nextBtn = modal?.querySelector("[data-gallery-next]");

        if (!modal || !image || !counter || !openButtons.length || !prevBtn || !nextBtn) return;

        const items = openButtons.map((btn) => ({
          src: btn.getAttribute("data-gallery-src") || "",
          alt: btn.getAttribute("data-gallery-alt") || "Referencia visual",
        }));

        let currentIndex = 0;

        const render = () => {
          const item = items[currentIndex];
          if (!item) return;
          image.setAttribute("src", item.src);
          image.setAttribute("alt", item.alt);
          counter.textContent = `${currentIndex + 1} de ${items.length}`;
        };

        const syncNavigation = () => {
          const showNav = items.length > 1;
          [prevBtn, nextBtn].forEach((btn) => {
            if (!btn) return;
            btn.classList.toggle("hidden", !showNav);
            btn.classList.toggle("flex", showNav);
            btn.setAttribute("aria-hidden", showNav ? "false" : "true");
            btn.toggleAttribute("disabled", !showNav);
          });
        };

        const open = (index) => {
          currentIndex = Number.isFinite(index) ? index : 0;
          if (currentIndex < 0) currentIndex = 0;
          if (currentIndex >= items.length) currentIndex = items.length - 1;
          render();
          syncNavigation();
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          modal.setAttribute("aria-hidden", "false");
          document.body.classList.add("overflow-hidden");
        };

        const close = () => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          modal.setAttribute("aria-hidden", "true");
          document.body.classList.remove("overflow-hidden");
        };

        const move = (delta) => {
          currentIndex = (currentIndex + delta + items.length) % items.length;
          render();
        };

        openButtons.forEach((btn, idx) => {
          btn.addEventListener("click", () => open(idx));
        });

        closeButtons.forEach((btn) => btn.addEventListener("click", close));
        prevBtn.addEventListener("click", () => move(-1));
        nextBtn.addEventListener("click", () => move(1));
        syncNavigation();

        document.addEventListener("keydown", (event) => {
          if (modal.classList.contains("hidden")) return;
          if (event.key === "Escape") close();
          if (event.key === "ArrowLeft") move(-1);
          if (event.key === "ArrowRight") move(1);
        });
      })();
    </script>
  )
}
